<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>D√©tail</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <style>
    body{font-family:Outfit, sans-serif; margin:0; background:#f3f6fd; color:#2d3436;}
    .wrap{max-width:1100px; margin:30px auto; padding:0 16px;}
    .card{background:#fff; border-radius:20px; padding:18px; box-shadow:0 10px 20px rgba(0,0,0,0.05); border:1px solid rgba(255,255,255,0.5); margin-bottom:16px;}
    a{color:#3498db; text-decoration:none; font-weight:600;}
    .muted{color:#636e72;}
    .chart{width:100%; height:620px; border-radius:16px; border:1px solid #ebedf0; overflow:hidden;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
        <div>
          <h1 id="title">D√©tail</h1>
          <div class="muted" id="subtitle">Chargement‚Ä¶</div>
        </div>
        <div><a href="carte.html">‚Üê Retour carte</a></div>
      </div>
    </div>

    <div class="card">
      <div id="chart" class="chart"></div>
      <div class="muted" style="margin-top:10px;">Astuce : zoom souris, survole pour voir les valeurs.</div>
    </div>
  </div>

  <script>
    function qs(name){
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    async function safeFetchJson(url){
      try{
        const r = await fetch(url, {cache:"no-store"});
        if(!r.ok) return null;
        return await r.json();
      }catch(e){ return null; }
    }

    function buildPlot(serie, yLabel){
      const el = document.getElementById("chart");
      if(!serie || !Array.isArray(serie.points) || serie.points.length === 0){
        el.innerHTML = '<div style="padding:18px;color:#636e72;">Aucune donn√©e pour afficher la courbe.</div>';
        return;
      }
      const x = serie.points.map(p => p.timestamp);
      const y = serie.points.map(p => p.value);

      const trace = {
        x, y,
        type: "scatter",
        mode: "lines+markers",
        hovertemplate: "%{x}<br><b>%{y:.3f}</b><extra></extra>"
      };

      const layout = {
        margin: {l: 60, r: 20, t: 30, b: 60},
        xaxis: {title: "Temps", type: "date"},
        yaxis: {title: yLabel, rangemode: "tozero"},
        paper_bgcolor: "white",
        plot_bgcolor: "white",
        hovermode: "x"
      };

      Plotly.newPlot(el, [trace], layout, {responsive:true, displaylogo:false});
    }

    (async()=>{
      const type = qs("type"); // parking | velo
      const name = qs("name");

      const title = document.getElementById("title");
      const subtitle = document.getElementById("subtitle");

      if(!type || !name){
        title.textContent = "Param√®tres manquants";
        subtitle.textContent = "Il manque type ou name dans l‚ÄôURL.";
        return;
      }

      title.textContent = (type === "parking" ? "üöó Parking : " : "üö≤ Station : ") + name;

      const catalog = await safeFetchJson("donnees/catalog.json");
      if(!catalog){
        subtitle.textContent = "catalog.json introuvable (g√©n√©r√© par carte_unique.py)";
        return;
      }

      let item = null;
      if(type === "parking"){
        item = (catalog.parkings || []).find(x => x.name === name);
      }else{
        item = (catalog.stations || []).find(x => x.name === name);
      }

      if(!item || !item.series){
        subtitle.textContent = "S√©rie introuvable pour ce point.";
        return;
      }

      subtitle.textContent = "Fichier : " + item.series;

      const serie = await safeFetchJson(item.series);
      const yLabel = (type === "parking") ? "Taux occupation" : "Taux occupation places";
      buildPlot(serie, yLabel);
    })();
  </script>
</body>
</html>
