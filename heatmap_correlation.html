<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Heatmap corr√©lations</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:Outfit, sans-serif; margin:0; background:#f3f6fd; color:#2d3436;}
    .wrap{max-width:1200px; margin:30px auto; padding:0 16px;}
    .card{background:#fff; border-radius:20px; padding:18px; box-shadow:0 10px 20px rgba(0,0,0,0.05); border:1px solid rgba(255,255,255,0.5); margin-bottom:16px;}
    a{color:#3498db; text-decoration:none; font-weight:700;}
    .muted{color:#636e72;}
    .chart{width:100%; height:720px; border-radius:16px; border:1px solid #ebedf0; overflow:hidden;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;}
    .pill{background:#f0f2f5; color:#636e72; padding:6px 12px; border-radius:999px; font-size:0.9rem; font-weight:700; display:inline-block;}
  </style>

  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <h1 style="margin:0;">üßä Heatmap des corr√©lations</h1>
          <div class="muted" id="meta">Chargement‚Ä¶</div>
          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <span class="pill" id="pCount">Parkings : ‚Ä¶</span>
            <span class="pill" id="sCount">Stations : ‚Ä¶</span>
            <span class="pill" id="minPts">Points min : ‚Ä¶</span>
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <a href="index.html">‚Üê Retour</a>
        </div>
      </div>
      <div class="muted" style="margin-top:10px; font-size:0.9rem;">
        Lecture : +1 signifie que les deux √©voluent dans le m√™me sens ; -1 signifie qu‚Äôils √©voluent en sens inverse ; proche de 0 signifie peu de relation lin√©aire.
      </div>
    </div>

    <div class="card">
      <div id="heatmap" class="chart"></div>
      <div class="muted" style="margin-top:10px; font-size:0.9rem;">
        Conseil : il est possible de zoomer et de d√©placer la vue directement sur le graphique.
      </div>
    </div>
  </div>

  <script>
    async function safeFetchJson(url){
      try{
        const r = await fetch(url, {cache:"no-store"});
        if(!r.ok) return null;
        return await r.json();
      }catch(e){ return null; }
    }

    (async()=>{
      const data = await safeFetchJson("donnees/heatmap_corr.json");
      if(!data){
        document.getElementById("meta").textContent = "‚ùå donnees/heatmap_corr.json introuvable (ex√©cuter generer_heatmap.py).";
        document.getElementById("heatmap").innerHTML =
          '<div style="padding:18px;color:#636e72;">Aucune donn√©e √† afficher.</div>';
        return;
      }

      const parkings = data.parkings || [];
      const stations = data.stations || [];
      const corr = data.corr || [];
      const npts = data.n_points || [];

      document.getElementById("meta").textContent = data.title || "Heatmap des corr√©lations";
      document.getElementById("pCount").textContent = "Parkings : " + parkings.length;
      document.getElementById("sCount").textContent = "Stations : " + stations.length;
      document.getElementById("minPts").textContent = "Points min : " + (data.min_points ?? "?");

      // Hover texte (corr + n_points)
      const hoverText = corr.map((row, i) =>
        row.map((val, j) => {
          const r = (typeof val === "number") ? val.toFixed(3) : "N/A";
          const np = (npts[i] && typeof npts[i][j] === "number") ? npts[i][j] : "?";
          return `<b>${parkings[i]}</b> ‚Üî ${stations[j]}<br>corr = <b>${r}</b><br>points = ${np}`;
        })
      );

      const trace = {
        x: stations,
        y: parkings,
        z: corr,
        type: "heatmap",
        zmin: -1,
        zmax: 1,
        text: hoverText,
        hoverinfo: "text"
      };

      const layout = {
        margin: {l: 220, r: 30, t: 40, b: 160},
        xaxis: {title: "Stations v√©lo", tickangle: 45},
        yaxis: {title: "Parkings voiture"},
        paper_bgcolor: "white",
        plot_bgcolor: "white"
      };

      Plotly.newPlot("heatmap", [trace], layout, {responsive:true, displaylogo:false});
    })();
  </script>
</body>
</html>
