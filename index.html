<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Montpellier Mobilit√© - Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="sidebar">
    <div class="logo">
      <h2>MTP<span>Data</span></h2>
    </div>

    <nav>
      <a href="index.html" class="active">Vue d'ensemble</a>
      <a href="carte.html">Carte (plein √©cran)</a>
      <a href="analyse_globale.html">Analyse globale</a>
      <a href="correlation.html">Corr√©lation (outil)</a>
    </nav>

    <div class="user-profile">
      <p>Bureau du Maire</p>
    </div>
  </div>

  <main class="content">
    <header>
      <div>
        <h1>Observatoire Mobilit√©</h1>
        <p class="subtitle">
          Donn√©es actualis√©es automatiquement (GitHub Actions)
          <span class="last-update" id="lastUpdate">‚Ä¢ Derni√®re mise √† jour : ‚Ä¶</span>
        </p>
      </div>
      <div class="status-badge">
        <span class="dot"></span> Syst√®me Actif
      </div>
    </header>

    <section class="cards-grid">
      <!-- KPI Corr√©lation -->
      <div class="card kpi">
        <div class="icon-box orange">üîó</div>
        <div class="kpi-info">
          <h3>Corr√©lation voiture ‚Üî v√©lo</h3>
          <p class="number" id="corrValue">‚Ä¶</p>
          <span class="trend neutral" id="corrLabel">Calcul automatique</span>
          <div style="margin-top:10px;">
            <a class="btn-link" href="correlation.html">Ouvrir l‚Äôoutil (choisir parking + station)</a>
          </div>
        </div>
      </div>

      <!-- KPI Carte -->
      <div class="card kpi">
        <div class="icon-box purple">üó∫Ô∏è</div>
        <div class="kpi-info">
          <h3>Carte interactive</h3>
          <p class="text-stat">Folium</p>
          <span class="sub-text">Clique un point ‚Üí infos + lien graphique interactif</span>
        </div>
      </div>

      <!-- KPI Analyse globale -->
      <div class="card kpi">
        <div class="icon-box blue">üìä</div>
        <div class="kpi-info">
          <h3>Analyse globale</h3>
          <p class="text-stat">Dashboard</p>
          <span class="sub-text">Courbes + indicateurs + r√©sum√©</span>
          <div style="margin-top:10px;">
            <a class="btn-link" href="analyse_globale.html">Ouvrir</a>
          </div>
        </div>
      </div>
    </section>

    <section class="main-grid">
      <div class="card graph-container">
        <div class="card-header">
          <h3>Carte Montpellier (parkings + v√©los)</h3>
        </div>

        <div class="map-wrapper">
          <iframe
            src="carte.html"
            title="Carte interactive"
            loading="lazy"
            referrerpolicy="no-referrer"
          ></iframe>
        </div>

        <div style="margin-top:12px; font-size:0.9rem; color:#636e72;">
          Astuce : tu peux ouvrir la carte en plein √©cran via le menu √† gauche.
        </div>
      </div>

      <div class="card info-container">
        <div class="card-header">
          <h3>Lecture rapide</h3>
        </div>

        <div class="alert-item">
          <span class="time">Conseil</span>
          <p><strong>Pour voir les infos :</strong> clique un point sur la carte ‚Üí popup + lien ‚Äúgraphique interactif‚Äù.</p>
        </div>

        <div class="alert-item">
          <span class="time">Lien</span>
          <p>Carte plein √©cran : <strong><a href="carte.html">carte.html</a></strong></p>
        </div>

        <div class="heatmap-mini">
          <h4>Corr√©lation (global)</h4>
          <p style="margin:6px 0 0 0;">
            Valeur calcul√©e sur les donn√©es brutes (snapshots JSONL) : <strong id="corrValue2">‚Ä¶</strong>
          </p>
          <p><small>Va dans ‚ÄúCorr√©lation (outil)‚Äù pour choisir un parking + une station.</small></p>
        </div>
      </div>
    </section>

  </main>

  <script>
    async function safeFetchJson(url) {
      try {
        const r = await fetch(url, { cache: "no-store" });
        if (!r.ok) return null;
        return await r.json();
      } catch (e) {
        return null;
      }
    }

    function formatTs(ts) {
      if (!ts) return "‚Ä¶";
      return ts.replace("T", " ").replace("+01:00", "");
    }

    function interpretCorr(c) {
      if (c === null || c === undefined || Number.isNaN(c)) return {label:"indispo", cls:"neutral"};
      const a = Math.abs(c);
      if (a >= 0.70) return {label:"forte", cls:"up"};
      if (a >= 0.40) return {label:"moyenne", cls:"neutral"};
      return {label:"faible", cls:"neutral"};
    }

    (async () => {
      const upd = await safeFetchJson("donnees/last_update.json");
      if (upd && upd.last_update) {
        document.getElementById("lastUpdate").textContent = "‚Ä¢ Derni√®re mise √† jour : " + formatTs(upd.last_update);
      } else {
        document.getElementById("lastUpdate").textContent = "‚Ä¢ Derni√®re mise √† jour : inconnue";
      }

      const corr = await safeFetchJson("donnees/correlation_global.json");
      if (corr && typeof corr.correlation === "number") {
        const c = corr.correlation;
        document.getElementById("corrValue").textContent = c.toFixed(3);
        document.getElementById("corrValue2").textContent = c.toFixed(3);

        const it = interpretCorr(c);
        const el = document.getElementById("corrLabel");
        el.textContent = "Corr√©lation " + it.label + " ‚Ä¢ n=" + (corr.n_points ?? "?");
        el.classList.remove("neutral","up");
        el.classList.add(it.cls);
      } else {
        document.getElementById("corrValue").textContent = "N/A";
        document.getElementById("corrValue2").textContent = "N/A";
      }
    })();
  </script>
</body>
</html>
