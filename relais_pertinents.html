<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Relais pertinents</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:Outfit, sans-serif; margin:0; background:#f3f6fd; color:#2d3436;}
    .wrap{max-width:1200px; margin:30px auto; padding:0 16px;}
    .card{background:#fff; border-radius:20px; padding:18px; box-shadow:0 10px 20px rgba(0,0,0,0.05); border:1px solid rgba(255,255,255,0.5); margin-bottom:16px;}
    a{color:#3498db; text-decoration:none; font-weight:700;}
    .muted{color:#636e72;}
    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px; border:1px solid #ebedf0;}
    th, td{padding:12px 10px; text-align:left; border-bottom:1px solid #ebedf0; font-size:0.95rem;}
    th{background:#f7f9ff; font-weight:800;}
    tr:last-child td{border-bottom:none;}
    .pill{display:inline-block; padding:6px 10px; border-radius:999px; background:#f0f2f5; font-weight:800; font-size:0.85rem; color:#2d3436;}
    .good{background:#e0fcf6; color:#00b894;}  /* relais fort (corr tr√®s n√©gative) */
    .warn{background:#ffeaa7; color:#2d3436;}  /* relais moyen */
    .bad{background:#ffe0e0; color:#d63031;}   /* relais faible / proche de 0 */
    .btn2{display:inline-block; padding:8px 12px; border-radius:12px; background:#2d3436; color:white; font-weight:800;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    input{font-family:Outfit, sans-serif; padding:10px 12px; border-radius:12px; border:1px solid #ebedf0;}
    code{background:#f7f9ff; padding:2px 6px; border-radius:8px; border:1px solid #ebedf0;}
  </style>
</head>
<body>
  <div class="wrap">

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
        <div>
          <h1 style="margin:0;">üîÅ Relais pertinents</h1>
          <div class="muted" id="meta">Chargement‚Ä¶</div>
          <div class="row" style="margin-top:10px;">
            <span class="pill" id="countPill">Couples : ‚Ä¶</span>
            <span class="pill" id="rulesPill">R√®gles : ‚Ä¶</span>
            <span class="pill" id="sortPill">Tri : ‚Ä¶</span>
          </div>
        </div>
        <div class="row">
          <a href="carte.html" class="btn2">üó∫Ô∏è Carte</a>
          <a href="index.html">‚Üê Retour</a>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <label class="muted">Filtrage par nom de parking ou de station</label>
        <input id="q" type="text" placeholder="Exemple : Com√©die" style="flex:1; min-width:220px;">
      </div>
      <div class="muted" style="margin-top:10px; font-size:0.9rem;">
        Interpr√©tation : un <b>relais</b> est recherch√© lorsque la <b>corr√©lation est n√©gative</b>
        (l‚Äôoccupation du parking augmente pendant que l‚Äôoccupation de la station diminue, ou inversement).
      </div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Parking</th>
            <th>Station</th>
            <th>Distance</th>
            <th>Corr√©lation</th>
            <th>Points</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" class="muted">Chargement‚Ä¶</td></tr>
        </tbody>
      </table>

      <div class="muted" style="margin-top:10px; font-size:0.9rem;" id="footerInfo">
        ‚Äî
      </div>
    </div>

  </div>

  <script>
    async function safeFetchJson(url){
      try{
        const r = await fetch(url, {cache:"no-store"});
        if(!r.ok) return null;
        return await r.json();
      }catch(e){ return null; }
    }

    // Un "relais" est recherch√© via corr√©lation n√©gative :
    // plus c'est proche de -1, plus la relation inverse est forte.
    function corrPillClass(r){
      if(typeof r !== "number") return "pill bad";
      if(r <= -0.60) return "pill good";
      if(r <= -0.30) return "pill warn";
      return "pill bad";
    }

    function fmtM(m){
      if(m < 1000) return Math.round(m) + " m";
      return (m/1000).toFixed(2) + " km";
    }

    function render(items, q){
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";

      const qq = (q || "").trim().toLowerCase();
      const filtered = items.filter(it => {
        if(!qq) return true;
        return (it.parking || "").toLowerCase().includes(qq) || (it.station || "").toLowerCase().includes(qq);
      });

      if(filtered.length === 0){
        tbody.innerHTML = '<tr><td colspan="6" class="muted">Aucun r√©sultat.</td></tr>';
        return;
      }

      filtered.forEach((it, idx) => {
        const tr = document.createElement("tr");
        const corr = (typeof it.correlation === "number") ? it.correlation : null;

        tr.innerHTML = `
          <td>${idx+1}</td>
          <td><b>${it.parking || "?"}</b></td>
          <td>${it.station || "?"}</td>
          <td>${fmtM(it.distance_m || 0)}</td>
          <td><span class="${corrPillClass(corr)}">${(corr === null ? "N/A" : corr.toFixed(3))}</span></td>
          <td>${it.n_points ?? "?"}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    (async()=>{
      const data = await safeFetchJson("donnees/relais_pertinents.json");
      if(!data){
        document.getElementById("meta").textContent = "‚ùå Le fichier donnees/relais_pertinents.json est introuvable.";
        document.getElementById("tbody").innerHTML =
          '<tr><td colspan="6" class="muted">V√©rifier que le script <code>generer_relais.py</code> est ex√©cut√© et que le workflow enregistre bien <code>donnees/relais_pertinents.json</code>.</td></tr>';
        document.getElementById("footerInfo").textContent = "‚Äî";
        return;
      }

      const items = data.items || [];

      document.getElementById("meta").textContent =
        "Liste de couples parking ‚Üî station proches pr√©sentant un comportement de relais (corr√©lation n√©gative).";

      document.getElementById("countPill").textContent = "Couples affich√©s : " + items.length;

      const dmax = data.max_distance_m ?? "?";
      const pmin = data.min_points ?? "?";
      const onlyNeg = (data.only_negative === true) ? "corr < 0" : "toutes corr";
      const minRel = (typeof data.min_relais_corr === "number") ? data.min_relais_corr.toFixed(2) : "‚Äî";

      document.getElementById("rulesPill").textContent =
        "Distance ‚â§ " + dmax + " m | points ‚â• " + pmin + " | filtre : " + onlyNeg + " | seuil : " + minRel;

      document.getElementById("sortPill").textContent =
        "Tri : " + (data.sort || "distance, puis corr√©lation, puis points");

      document.getElementById("footerInfo").textContent =
        "Tri : distance la plus faible d‚Äôabord (couple le plus proche), puis corr√©lation (plus n√©gative = relais plus marqu√©), puis nombre de points (fiabilit√©).";

      const q = document.getElementById("q");
      q.addEventListener("input", () => render(items, q.value));
      render(items, "");
    })();
  </script>
</body>
</html>
