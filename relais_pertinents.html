<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üîÅ Relais pertinents</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:Outfit, sans-serif; margin:0; background:#f3f6fd; color:#2d3436;}
    .wrap{max-width:1200px; margin:30px auto; padding:0 16px;}
    .card{background:#fff; border-radius:20px; padding:18px; box-shadow:0 10px 20px rgba(0,0,0,0.05); border:1px solid rgba(255,255,255,0.5); margin-bottom:16px;}
    a{color:#3498db; text-decoration:none; font-weight:700;}
    .muted{color:#636e72;}
    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px; border:1px solid #ebedf0;}
    th, td{padding:12px 10px; text-align:left; border-bottom:1px solid #ebedf0; font-size:0.95rem;}
    th{background:#f7f9ff; font-weight:800;}
    tr:last-child td{border-bottom:none;}
    .pill{display:inline-block; padding:6px 10px; border-radius:999px; background:#f0f2f5; font-weight:800; font-size:0.85rem; color:#2d3436;}
    .good{background:#e0fcf6; color:#00b894;}
    .warn{background:#ffeaa7; color:#2d3436;}
    .bad{background:#ffe0e0; color:#d63031;}
    .btn{display:inline-block; padding:8px 12px; border-radius:12px; background:#3498db; color:white; font-weight:800;}
    .btn2{display:inline-block; padding:8px 12px; border-radius:12px; background:#2d3436; color:white; font-weight:800;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    input{font-family:Outfit, sans-serif; padding:10px 12px; border-radius:12px; border:1px solid #ebedf0;}
  </style>
</head>
<body>
  <div class="wrap">

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
        <div>
          <h1 style="margin:0;">üîÅ Relais pertinents</h1>
          <div class="muted" id="meta">Chargement‚Ä¶</div>
          <div class="row" style="margin-top:10px;">
            <span class="pill" id="countPill">Couples : ‚Ä¶</span>
            <span class="pill" id="rulesPill">R√®gles : ‚Ä¶</span>
          </div>
        </div>
        <div class="row">
          <a href="carte.html" class="btn2">üó∫Ô∏è Carte</a>
          <a href="index.html">‚Üê Retour</a>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <label class="muted">Filtrage par nom de parking ou de station</label>
        <input id="q" type="text" placeholder="ex: Comedie" style="flex:1; min-width:220px;">
      </div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Parking</th>
            <th>Station</th>
            <th>Distance</th>
            <th>Corr√©lation</th>
            <th>Points</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" class="muted">Chargement‚Ä¶</td></tr>
        </tbody>
      </table>
      <div class="muted" style="margin-top:10px; font-size:0.9rem;">
        Tri : meilleurs d‚Äôabord (|corr√©lation|), puis distance.
      </div>
    </div>

  </div>

  <script>
    async function safeFetchJson(url){
      try{
        const r = await fetch(url, {cache:"no-store"});
        if(!r.ok) return null;
        return await r.json();
      }catch(e){ return null; }
    }

    function corrPillClass(r){
      const a = Math.abs(r);
      if(a >= 0.6) return "pill good";
      if(a >= 0.3) return "pill warn";
      return "pill bad";
    }

    function fmtM(m){
      if(m < 1000) return Math.round(m) + " m";
      return (m/1000).toFixed(2) + " km";
    }

    function render(items, q){
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";

      const qq = (q || "").trim().toLowerCase();
      const filtered = items.filter(it => {
        if(!qq) return true;
        return (it.parking || "").toLowerCase().includes(qq) || (it.station || "").toLowerCase().includes(qq);
      });

      if(filtered.length === 0){
        tbody.innerHTML = '<tr><td colspan="6" class="muted">Aucun r√©sultat.</td></tr>';
        return;
      }

      filtered.forEach((it, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td><b>${it.parking || "?"}</b></td>
          <td>${it.station || "?"}</td>
          <td>${fmtM(it.distance_m || 0)}</td>
          <td><span class="${corrPillClass(it.correlation)}">${(it.correlation ?? 0).toFixed(3)}</span></td>
          <td>${it.n_points ?? "?"}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    (async()=>{
      const data = await safeFetchJson("donnees/relais_pertinents.json");
      if(!data){
        document.getElementById("meta").textContent = "‚ùå donnees/relais_pertinents.json introuvable";
        document.getElementById("tbody").innerHTML = '<tr><td colspan="6" class="muted">Lance generer_relais.py dans ton workflow.</td></tr>';
        return;
      }

      const items = data.items || [];
      document.getElementById("meta").textContent = "Meilleurs relais parking ‚Üî station proches.";
      document.getElementById("countPill").textContent = "Couples affich√©s : " + items.length;
      document.getElementById("rulesPill").textContent =
        "Distance ‚â§ " + (data.max_distance_m ?? "?") + " m | points ‚â• " + (data.min_points ?? "?");

      const q = document.getElementById("q");
      q.addEventListener("input", () => render(items, q.value));
      render(items, "");
    })();
  </script>
</body>
</html>
